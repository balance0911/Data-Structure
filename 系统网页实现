<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸­è¯åº“å­˜é¢„è­¦ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2a9d8f;
      --primary-dark: #1d6f64;
      --primary-light: #76c7ba;
      --secondary-color: #264653;
      --accent-color: #e9c46a;
      --warning-color: #e76f51;
      --success-color: #2a9d8f;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-dark: #264653;
      --text-light: #6c757d;
      --border-radius: 12px;
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.05);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #f0f7fa 0%, #e6f4f1 100%);
      color: var(--text-dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1300px;
      margin: 0 auto;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .header {
      background: linear-gradient(to right, var(--secondary-color), var(--primary-dark));
      color: white;
      padding: 25px 30px;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header p {
      font-size: 1rem;
      opacity: 0.85;
      max-width: 800px;
    }

    /* å¯¼èˆªèœå• */
    .nav-menu {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 20px 30px;
      background-color: var(--light-bg);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .nav-btn {
      padding: 14px 22px;
      background-color: white;
      color: var(--text-dark);
      border: 2px solid transparent;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: var(--shadow-light);
    }

    .nav-btn:hover {
      background-color: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(42, 157, 143, 0.25);
    }

    .nav-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-light);
    }

    /* å†…å®¹åŒºåŸŸ */
    .content-section {
      padding: 30px;
      display: none;
    }

    .content-section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-size: 1.8rem;
      color: var(--secondary-color);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary-light);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-title i {
      color: var(--primary-color);
      background-color: rgba(42, 157, 143, 0.1);
      padding: 10px;
      border-radius: 50%;
    }

    /* æŒ‰é’®æ ·å¼ */
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(42, 157, 143, 0.3);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #1a3645;
      transform: translateY(-2px);
    }

    .btn-warning {
      background-color: var(--warning-color);
      color: white;
    }

    .btn-warning:hover {
      background-color: #d45c3e;
      transform: translateY(-2px);
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
    }

    /* å¡ç‰‡æ ·å¼ */
    .card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 25px;
      box-shadow: var(--shadow-light);
      margin-bottom: 25px;
      border-left: 5px solid var(--primary-color);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 1.3rem;
      color: var(--secondary-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* è¡¨å•æ ·å¼ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 1rem;
      transition: var(--transition);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.2);
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
    }

    .form-col {
      flex: 1;
      min-width: 200px;
    }

    /* è¡¨æ ¼æ ·å¼ */
    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-light);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      padding: 16px 12px;
      text-align: left;
    }

    td {
      padding: 14px 12px;
      border-bottom: 1px solid #eef2f7;
    }

    tr:hover {
      background-color: #f8fafc;
    }

    tr:nth-child(even) {
      background-color: #f8fafc;
    }

    /* é¢„è­¦çŠ¶æ€ */
    .status-normal {
      color: var(--success-color);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-warning {
      color: var(--warning-color);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* æ—¥å¿—åŒºåŸŸ */
    .log-container {
      max-height: 200px;
      overflow-y: auto;
      padding: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e0e6ed;
      margin-top: 20px;
    }

    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid #eef2f7;
      font-size: 0.9rem;
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 25px;
      text-align: center;
      box-shadow: var(--shadow-light);
      transition: var(--transition);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.1);
    }

    .stat-icon {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--secondary-color);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 1rem;
      color: var(--text-light);
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .nav-menu {
        justify-content: center;
      }

      .nav-btn {
        flex: 1;
        min-width: 150px;
        justify-content: center;
      }

      .form-row {
        flex-direction: column;
      }

      .btn-group {
        justify-content: center;
      }

      .header h1 {
        font-size: 1.8rem;
      }

      .stats-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--primary-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-color);
    }

    /* é¢„è­¦å¼¹çª—æ ·å¼ */
    .alert-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .alert-content {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: var(--shadow);
      border-left: 6px solid var(--warning-color);
      position: relative;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .alert-icon {
      color: var(--warning-color);
      font-size: 2rem;
    }

    .alert-title {
      font-size: 1.5rem;
      color: var(--warning-color);
      font-weight: 600;
    }

    .alert-message {
      color: var(--text-dark);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .alert-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-light);
      cursor: pointer;
      transition: var(--transition);
    }

    .alert-close:hover {
      color: var(--warning-color);
    }
  </style>
</head>
<body>
<div class="container">
  <!-- å¤´éƒ¨ -->
  <div class="header">
    <h1><i class="fas fa-leaf"></i> ä¸­è¯åº“å­˜é¢„è­¦ç³»ç»Ÿ</h1>
    <p>æ™ºèƒ½åŒ–ç®¡ç†ä¸­è¯åº“å­˜ï¼Œå®æ—¶é¢„è­¦ï¼Œä¿éšœè¯å“ä¾›åº”å®‰å…¨ã€‚ç³»ç»Ÿæä¾›è¯å“ç®¡ç†ã€å‡ºå…¥åº“è®°å½•ã€é¢„è­¦ç›‘æ§å’Œç»Ÿè®¡æŠ¥è¡¨åŠŸèƒ½ã€‚</p>
  </div>

  <!-- å¯¼èˆªèœå• -->
  <div class="nav-menu">
    <button class="nav-btn active" data-section="medicine">
      <i class="fas fa-pills"></i> è¯å“ç®¡ç†
    </button>
    <button class="nav-btn" data-section="inout">
      <i class="fas fa-exchange-alt"></i> å…¥åº“/å‡ºåº“
    </button>
    <button class="nav-btn" data-section="warning">
      <i class="fas fa-exclamation-triangle"></i> é¢„è­¦ç®¡ç†
    </button>
    <button class="nav-btn" data-section="report">
      <i class="fas fa-chart-bar"></i> ç»Ÿè®¡æŠ¥è¡¨
    </button>
    <button class="nav-btn" data-section="ledger">
      <i class="fas fa-book"></i> åº“å­˜å°è´¦
    </button>
  </div>

  <!-- è¯å“ç®¡ç† -->
  <div id="medicineSection" class="content-section active">
    <h2 class="section-title"><i class="fas fa-pills"></i> è¯å“ç®¡ç†</h2>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="addMedicineForm()">
        <i class="fas fa-plus"></i> æ–°å¢è¯å“
      </button>
      <button class="btn btn-secondary" onclick="listAllMedicines()">
        <i class="fas fa-list"></i> æ˜¾ç¤ºæ‰€æœ‰è¯å“
      </button>
      <button class="btn btn-primary" onclick="queryMedicineForm()">
        <i class="fas fa-search"></i> æŸ¥è¯¢è¯å“
      </button>
    </div>

    <!-- è¯å“è¡¨å• -->
    <div id="medicineForm" class="card" style="display:none;">
      <h3 class="card-title" id="formTitle"><i class="fas fa-edit"></i> æ–°å¢è¯å“</h3>
      <input type="hidden" id="editId" />
      <div class="form-row">
        <div class="form-col">
          <label class="form-label">è¯å“ID</label>
          <input type="number" id="medId" min="1" class="form-input" placeholder="è¯·è¾“å…¥è¯å“ID">
        </div>
        <div class="form-col">
          <label class="form-label">è¯å“åç§°</label>
          <input type="text" id="medName" class="form-input" placeholder="è¯·è¾“å…¥è¯å“åç§°">
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label class="form-label">äº§åœ°</label>
          <input type="text" id="medOrigin" class="form-input" placeholder="è¯·è¾“å…¥äº§åœ°">
        </div>
        <div class="form-col">
          <label class="form-label">è§„æ ¼</label>
          <input type="text" id="medSpec" class="form-input" placeholder="è¯·è¾“å…¥è§„æ ¼">
        </div>
      </div>
      <div class="form-row">
        <div class="form-col">
          <label class="form-label">åº“å­˜(g)</label>
          <input type="number" id="medStock" min="0" class="form-input" placeholder="è¯·è¾“å…¥åº“å­˜é‡">
        </div>
        <div class="form-col">
          <label class="form-label">é¢„è­¦é˜ˆå€¼(g)</label>
          <input type="number" id="medThreshold" min="0" class="form-input" placeholder="è¯·è¾“å…¥é¢„è­¦é˜ˆå€¼">
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveMedicine()">
          <i class="fas fa-save"></i> ä¿å­˜
        </button>
        <button class="btn" onclick="document.getElementById('medicineForm').style.display='none'" style="background-color: #e0e6ed;">
          <i class="fas fa-times"></i> å–æ¶ˆ
        </button>
      </div>
    </div>

    <!-- è¯å“åˆ—è¡¨ -->
    <div id="medicineList" class="table-container"></div>
  </div>

  <!-- å…¥åº“/å‡ºåº“ -->
  <div id="inoutSection" class="content-section">
    <h2 class="section-title"><i class="fas fa-exchange-alt"></i> å…¥åº“ / å‡ºåº“</h2>

    <div class="form-row">
      <!-- å…¥åº“ -->
      <div class="card" style="flex: 1;">
        <h3 class="card-title"><i class="fas fa-sign-in-alt text-success"></i> å…¥åº“æ“ä½œ</h3>
        <div class="form-group">
          <label class="form-label">è¯å“ID</label>
          <input type="number" id="inMedId" class="form-input" placeholder="è¯·è¾“å…¥è¯å“ID">
        </div>
        <div class="form-group">
          <label class="form-label">æ•°é‡(g)</label>
          <input type="number" id="inQty" min="1" class="form-input" placeholder="è¯·è¾“å…¥å…¥åº“æ•°é‡">
        </div>
        <div class="form-group">
          <label class="form-label">æ“ä½œå‘˜</label>
          <input type="text" id="inOperator" class="form-input" placeholder="è¯·è¾“å…¥æ“ä½œå‘˜å§“å">
        </div>
        <button class="btn btn-success" onclick="doIn()">
          <i class="fas fa-arrow-down"></i> æ‰§è¡Œå…¥åº“
        </button>
      </div>

      <!-- å‡ºåº“ -->
      <div class="card" style="flex: 1;">
        <h3 class="card-title"><i class="fas fa-sign-out-alt text-warning"></i> å‡ºåº“æ“ä½œ</h3>
        <div class="form-group">
          <label class="form-label">è¯å“ID</label>
          <input type="number" id="outMedId" class="form-input" placeholder="è¯·è¾“å…¥è¯å“ID">
        </div>
        <div class="form-group">
          <label class="form-label">æ•°é‡(g)</label>
          <input type="number" id="outQty" min="1" class="form-input" placeholder="è¯·è¾“å…¥å‡ºåº“æ•°é‡">
        </div>
        <div class="form-group">
          <label class="form-label">å¤„æ–¹å·</label>
          <input type="text" id="prescriptionNo" class="form-input" placeholder="è¯·è¾“å…¥å¤„æ–¹å·">
        </div>
        <button class="btn btn-warning" onclick="doOut()">
          <i class="fas fa-arrow-up"></i> æ‰§è¡Œå‡ºåº“
        </button>
      </div>
    </div>

    <!-- æ“ä½œæ—¥å¿— -->
    <div class="card">
      <h3 class="card-title"><i class="fas fa-history"></i> æ“ä½œæ—¥å¿—</h3>
      <div id="inoutLog" class="log-container"></div>
    </div>
  </div>

  <!-- é¢„è­¦ç®¡ç† -->
  <div id="warningSection" class="content-section">
    <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> é¢„è­¦ç®¡ç†</h2>

    <div class="btn-group">
      <button class="btn btn-warning" onclick="updateAllWarnings()">
        <i class="fas fa-sync-alt"></i> æ‰¹é‡æ›´æ–°é¢„è­¦çŠ¶æ€
      </button>
      <button class="btn btn-primary" onclick="setThresholdByUsage()">
        <i class="fas fa-calculator"></i> æŒ‰è¿‘3æ—¥ç”¨é‡è®¾ç½®é˜ˆå€¼
      </button>
      <button class="btn btn-secondary" onclick="showResponseTimeReport()">
        <i class="fas fa-clock"></i> å“åº”æ—¶é—´æŠ¥è¡¨
      </button>
    </div>

    <!-- é¢„è­¦åˆ—è¡¨ -->
    <div class="card">
      <h3 class="card-title"><i class="fas fa-bell"></i> å½“å‰é¢„è­¦è¯å“</h3>
      <div id="warningList">
        <!-- è¿™é‡Œä¼šåŠ¨æ€æ˜¾ç¤ºé¢„è­¦è¯å“ -->
      </div>
    </div>

    <!-- å“åº”æ—¶é—´æŠ¥è¡¨åŒºåŸŸ -->
    <div id="responseTimeReport" class="card" style="display:none; margin-top: 20px;">
      <h3 class="card-title"><i class="fas fa-clock"></i> é¢„è­¦å“åº”æ—¶é—´æŠ¥è¡¨</h3>
      <div id="responseTimeContent">
        <!-- å“åº”æ—¶é—´å†…å®¹ä¼šåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- ç»Ÿè®¡æŠ¥è¡¨ -->
  <div id="reportSection" class="content-section">
    <h2 class="section-title"><i class="fas fa-chart-bar"></i> ç»Ÿè®¡æŠ¥è¡¨</h2>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="showDailyReport()">
        <i class="fas fa-calendar-day"></i> ç”Ÿæˆæ—¥æŠ¥è¡¨
      </button>
      <button class="btn btn-secondary" onclick="showUsageRanking()">
        <i class="fas fa-chart-line"></i> è¿‘3æ—¥ç”¨é‡æ’å
      </button>
      <button class="btn btn-primary" onclick="showFrequencyRanking()">
        <i class="fas fa-sort-amount-down"></i> è¿‘3æ—¥é¢‘æ¬¡æ’å
      </button>
      <button class="btn btn-warning" onclick="showAvgResponseTime()">
        <i class="fas fa-stopwatch"></i> å¹³å‡å“åº”æ—¶é—´
      </button>
    </div>

    <div id="reportOutput">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-boxes"></i>
          </div>
          <div class="stat-value" id="totalMedicines">0</div>
          <div class="stat-label">è¯å“æ€»æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-value" id="warningCount">0</div>
          <div class="stat-label">é¢„è­¦è¯å“</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-prescription-bottle-alt"></i>
          </div>
          <div class="stat-value" id="todayOut">0</div>
          <div class="stat-label">ä»Šæ—¥å‡ºåº“é‡(g)</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-value" id="avgResponseTime">0</div>
          <div class="stat-label">å¹³å‡å“åº”(åˆ†)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- åº“å­˜å°è´¦ -->
  <div id="ledgerSection" class="content-section">
    <h2 class="section-title"><i class="fas fa-book"></i> åº“å­˜å°è´¦</h2>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="generateLedger()">
        <i class="fas fa-file-export"></i> ç”Ÿæˆå½“æ—¥å°è´¦
      </button>
    </div>

    <div class="card">
      <h3 class="card-title"><i class="fas fa-table"></i> åº“å­˜å°è´¦è¯¦æƒ…</h3>
      <div id="ledgerTable">
        <p style="text-align: center; color: var(--text-light); padding: 30px;">
          <i class="fas fa-file-alt fa-2x" style="color: var(--primary-light); margin-bottom: 15px; display: block;"></i>
          ç‚¹å‡»"ç”Ÿæˆå½“æ—¥å°è´¦"æŒ‰é’®æŸ¥çœ‹åº“å­˜è¯¦æƒ…
        </p>
      </div>
    </div>
  </div>
</div>

<!-- é¢„è­¦å¼¹çª— -->
<div id="alertModal" class="alert-modal">
  <div class="alert-content">
    <button class="alert-close" onclick="closeAlert()">Ã—</button>
    <div class="alert-header">
      <i class="fas fa-exclamation-triangle alert-icon"></i>
      <div class="alert-title">åº“å­˜é¢„è­¦æé†’</div>
    </div>
    <div class="alert-message" id="alertMessage">
      è¯æåº“å­˜å·²è¾¾é¢„è­¦é˜ˆå€¼ï¼Œè¯·å°½å¿«è¡¥å……åº“å­˜ã€‚
    </div>
    <button class="btn btn-primary" onclick="closeAlert()">
      <i class="fas fa-check"></i> æˆ‘çŸ¥é“äº†
    </button>
  </div>
</div>

<script>
// ================== æ•°æ®åˆå§‹åŒ– ==================
let medicines = []; // è¯å“åˆ—è¡¨ [{id, name, origin, spec, stock, warning_threshold, is_warning, usage_history: [7], last_usage}]
let inOrders = [];  // å…¥åº“å•é˜Ÿåˆ— [{med_id, quantity, operator_name, date}]
let outOrders = []; // å‡ºåº“å•æ ˆï¼ˆæ•°ç»„ï¼Œé¡¶éƒ¨åœ¨æœ«å°¾ï¼‰[{med_id, quantity, prescription_no, date}]

// å½“å‰æ—¥æœŸå·¥å…·
function today() {
  const d = new Date();
  return d.toISOString().split('T')[0]; // "YYYY-MM-DD"
}

// åŠ è½½ CSV æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
function loadInitialData() {
  // è§£æè¯ç‰©åŸºæœ¬ä¿¡æ¯.csv
  const basicCSV = `ç¼–å·,åç§°,äº§åœ°,è§„æ ¼,åº“å­˜é‡(g),åŸºç¡€é˜ˆå€¼(g)
ZY0001,éº»é»„,å†…è’™å¤,é¥®ç‰‡/500g,12500,3000,
ZY0002,æ¡‚æ,å¹¿è¥¿,é¥®ç‰‡/500g,8500,2000,
ZY0003,ç´«è‹å¶,æ±Ÿè‹,é¥®ç‰‡/250g,6200,1500,
ZY0004,è†èŠ¥,æ±Ÿè¥¿,é¥®ç‰‡/500g,7800,1800,
ZY0005,é˜²é£,é»‘é¾™æ±Ÿ,é¥®ç‰‡/500g,9200,2200,
ZY0006,ç¾Œæ´»,å››å·,é¥®ç‰‡/500g,6800,1600,
ZY0007,ç™½èŠ·,æµ™æ±Ÿ,é¥®ç‰‡/500g,7500,1700,
ZY0008,ç»†è¾›,è¾½å®,é¥®ç‰‡/100g,3500,800,
ZY0009,è–„è·,æ±Ÿè‹,é¥®ç‰‡/250g,4800,1200,
ZY0010,èŠèŠ±,å®‰å¾½,é¥®ç‰‡/500g,10500,2500,
ZY0011,çŸ³è†,æ¹–åŒ—,é¥®ç‰‡/1000g,18200,5000,
ZY0012,çŸ¥æ¯,æ²³åŒ—,é¥®ç‰‡/500g,9200,2200,
ZY0013,æ €å­,æ¹–å—,é¥®ç‰‡/500g,7800,1800,
ZY0014,é»„èŠ©,å±±è¥¿,é¥®ç‰‡/500g,8600,2000,
ZY0015,é»„è¿,å››å·,é¥®ç‰‡/100g,4200,1000,
ZY0016,é»„æŸ,è´µå·,é¥®ç‰‡/500g,6500,1500,
ZY0017,é‡‘é“¶èŠ±,å±±ä¸œ,é¥®ç‰‡/500g,12800,3000,
ZY0018,è¿ç¿˜,æ²³å—,é¥®ç‰‡/500g,9500,2200,
ZY0019,è’²å…¬è‹±,é™•è¥¿,é¥®ç‰‡/500g,5800,1400,
ZY0020,æ¿è“æ ¹,å®‰å¾½,é¥®ç‰‡/500g,13200,3200,
ZY0021,äººå‚,å‰æ—,é¥®ç‰‡/100g,8500,2000,
ZY0022,é»„èŠª,ç”˜è‚ƒ,é¥®ç‰‡/500g,25600,6000,
ZY0023,ç™½æœ¯,æµ™æ±Ÿ,é¥®ç‰‡/500g,14200,3500,
ZY0024,ç”˜è‰,å†…è’™å¤,é¥®ç‰‡/500g,32400,8000,
ZY0025,å½“å½’,ç”˜è‚ƒ,é¥®ç‰‡/500g,18300,4500,
ZY0026,ç†Ÿåœ°é»„,æ²³å—,é¥®ç‰‡/500g,16800,4000,
ZY0027,ç™½èŠ,å®‰å¾½,é¥®ç‰‡/500g,12500,3000,
ZY0028,é˜¿èƒ¶,å±±ä¸œ,å—/250g,6200,1500,
ZY0029,æ¸æå­,å®å¤,é¥®ç‰‡/500g,9800,2400,
ZY0030,å¤§æ£,æ–°ç–†,é¥®ç‰‡/500g,21500,5000,
ZY0031,åŠå¤,å››å·,é¥®ç‰‡/500g,7200,1800,
ZY0032,é™ˆçš®,å¹¿ä¸œ,é¥®ç‰‡/500g,15600,3800,
ZY0033,èŒ¯è‹“,äº‘å—,é¥®ç‰‡/500g,23400,5500,
ZY0034,æ³½æ³»,ç¦å»º,é¥®ç‰‡/500g,8900,2100,
ZY0035,é™„å­,å››å·,é¥®ç‰‡/100g,3100,800,
ZY0036,è‚‰æ¡‚,å¹¿è¥¿,é¥®ç‰‡/250g,5200,1300,
ZY0037,å±±æ¥‚,å±±ä¸œ,é¥®ç‰‡/500g,6800,1600,
ZY0038,éº¦èŠ½,æ²³åŒ—,é¥®ç‰‡/500g,7500,1800,
ZY0039,ä¸‰ä¸ƒ,äº‘å—,é¥®ç‰‡/100g,4600,1100,
ZY0040,ç™½åŠ,è´µå·,é¥®ç‰‡/500g,3800,900,
ZY0041,ä¸¹å‚,å››å·,é¥®ç‰‡/500g,14200,3400,
ZY0042,å·èŠ,å››å·,é¥®ç‰‡/500g,10800,2600,
ZY0043,é…¸æ£ä»,æ²³åŒ—,é¥®ç‰‡/500g,9200,2200,
ZY0044,è¿œå¿—,å±±è¥¿,é¥®ç‰‡/500g,5800,1400,
ZY0045,å¤©éº»,è´µå·,é¥®ç‰‡/500g,12400,3000,
ZY0046,é’©è—¤,å¹¿è¥¿,é¥®ç‰‡/500g,7600,1800,
ZY0047,èœˆèš£,æ¹–åŒ—,æ¡/10æ¡,240,60,
ZY0048,éºé¦™,è¥¿è—,å…‹/1g,85,20,
ZY0049,å†°ç‰‡,å¹¿ä¸œ,å…‹/100g,3200,800,
ZY0050,é»„èŠª,ç”˜è‚ƒ,é¥®ç‰‡/500g,25600,6000`;

  const lines = basicCSV.trim().split('\n');
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(',');
    if (parts.length >= 6) {
      const id = parseInt(parts[0].replace('ZY', ''));
      medicines.push({
        id,
        name: parts[1],
        origin: parts[2],
        spec: parts[3],
        stock: parseInt(parts[4]),
        warning_threshold: parseInt(parts[5]),
        is_warning: false,
        usage_history: Array(7).fill(0),
        last_usage: 0,
        // æ–°å¢å­—æ®µï¼šé¢„è­¦å¼€å§‹æ—¶é—´ã€å“åº”æ—¶é—´è®°å½•
        warning_start_time: null,  // é¢„è­¦å¼€å§‹æ—¶é—´
        warning_response_times: []  // å†å²å“åº”æ—¶é—´è®°å½• [{start, end, duration_minutes}]
      });
    }
  }

  // åˆå§‹åŒ–è¿‘7æ—¥ç”¨é‡ï¼ˆä»…å‰5ç§æœ‰æ•°æ®ï¼‰
  const usageCSV = `Ñ…ÑƒÑ„Ğ·,Ğ±Ğ˜â•©Ñ„(ZY0001),â•§ĞŸĞ¶â••(ZY0002),Ğ²Ğ¾ĞºÑƒÑ€â•¤(ZY0003),â•¬Ñ‘â•«Ğ¤(ZY0004),â•¥Ñâ•¥Ğ“(ZY0005)
D-6,850,620,480,520,710
D-5,920,580,510,490,680
D-4,780,650,460,530,720
D-3,1050,720,550,580,810
D-2,980,680,520,560,790
D-1,1100,750,590,610,850
D-0,890,640,500,540,730`;

  const usageLines = usageCSV.trim().split('\n');
  const headers = usageLines[0].split(',').slice(1); // è·³è¿‡ç¬¬ä¸€åˆ—
  const medIdsFromHeader = headers.map(h => parseInt(h.match(/\d+/)[0])); // æå– ZY0001 â†’ 1

  for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
    const values = usageLines[dayIdx + 1].split(',').slice(1);
    for (let j = 0; j < values.length; j++) {
      const medId = medIdsFromHeader[j];
      const med = medicines.find(m => m.id === medId);
      if (med) {
        med.usage_history[dayIdx] = parseInt(values[j]);
        if (dayIdx === 6) med.last_usage = parseInt(values[j]);
      }
    }
  }

  console.log("åˆå§‹æ•°æ®åŠ è½½å®Œæˆ", medicines);
  updateStats();
}

// ================== å·¥å…·å‡½æ•° ==================
function findMedicine(id) {
  return medicines.find(m => m.id === id);
}

function log(msg) {
  const logDiv = document.getElementById('inoutLog');
  const time = new Date().toLocaleTimeString();
  let icon = 'ğŸ“';
  if (msg.includes('æˆåŠŸ')) icon = 'âœ…';
  if (msg.includes('å…¥åº“')) icon = 'ğŸ“¥';
  if (msg.includes('å‡ºåº“')) icon = 'ğŸ“¤';
  if (msg.includes('é¢„è­¦')) icon = 'âš ï¸';
  if (msg.includes('åˆ é™¤')) icon = 'ğŸ—‘ï¸';
  if (msg.includes('é”™è¯¯') || msg.includes('ä¸è¶³')) icon = 'âŒ';

  logDiv.innerHTML += `<div class="log-entry"><strong>${time}</strong> ${icon} ${msg}</div>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

// ================== é¢„è­¦å¼¹çª—æ§åˆ¶ ==================
function showAlert(medName, stock, threshold) {
  const modal = document.getElementById('alertModal');
  const message = document.getElementById('alertMessage');
  const now = new Date();
  const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  message.innerHTML = `
    <p><strong>${medName}</strong> çš„åº“å­˜å·²è¾¾åˆ°é¢„è­¦é˜ˆå€¼ï¼</p>
    <p>é¢„è­¦æ—¶é—´: <strong>${timeString}</strong></p>
    <p>å½“å‰åº“å­˜: <strong style="color: var(--warning-color);">${stock}g</strong></p>
    <p>é¢„è­¦é˜ˆå€¼: <strong>${threshold}g</strong></p>
    <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
      <i class="fas fa-info-circle"></i> ç³»ç»Ÿå·²å¼€å§‹è®°å½•å“åº”æ—¶é—´ï¼Œå…¥åº“åä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºå“åº”æ—¶é•¿ã€‚
    </p>
  `;
  modal.style.display = 'flex';
}

function closeAlert() {
  document.getElementById('alertModal').style.display = 'none';
}

// ç‚¹å‡»å¼¹çª—èƒŒæ™¯ä¹Ÿå¯å…³é—­
document.getElementById('alertModal').addEventListener('click', function(e) {
  if (e.target.id === 'alertModal') {
    closeAlert();
  }
});

// ================== è¯å“ç®¡ç† ==================
function addMedicineForm() {
  document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus"></i> æ–°å¢è¯å“';
  document.getElementById('editId').value = '';
  ['medId','medName','medOrigin','medSpec','medStock','medThreshold'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('medicineForm').style.display = 'block';
}

function saveMedicine() {
  const id = parseInt(document.getElementById('medId').value);
  const existing = findMedicine(id);
  const isEdit = document.getElementById('editId').value !== '';

  if (!isEdit && existing) {
    alert('è¯å“IDå·²å­˜åœ¨ï¼');
    return;
  }

  const med = {
    id,
    name: document.getElementById('medName').value,
    origin: document.getElementById('medOrigin').value,
    spec: document.getElementById('medSpec').value,
    stock: parseInt(document.getElementById('medStock').value) || 0,
    warning_threshold: parseInt(document.getElementById('medThreshold').value) || 0,
    is_warning: false,
    usage_history: Array(7).fill(0),
    last_usage: 0,
    warning_start_time: null,
    warning_response_times: []
  };

  if (isEdit) {
    const idx = medicines.findIndex(m => m.id === id);
    medicines[idx] = med;
  } else {
    medicines.push(med);
  }

  document.getElementById('medicineForm').style.display = 'none';
  listAllMedicines();
  log(`âœ… ${isEdit ? 'ä¿®æ”¹' : 'æ–°å¢'}è¯å“: ${med.name} (ID:${med.id})`);
  updateStats();
}

function listAllMedicines() {
  let html = `<table>
    <thead>
      <tr>
        <th>ID</th>
        <th>åç§°</th>
        <th>äº§åœ°</th>
        <th>è§„æ ¼</th>
        <th>åº“å­˜(g)</th>
        <th>é˜ˆå€¼(g)</th>
        <th>çŠ¶æ€</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>`;

  medicines.forEach(m => {
    html += `<tr>
      <td><strong>${m.id}</strong></td>
      <td><strong>${m.name}</strong></td>
      <td>${m.origin}</td>
      <td>${m.spec}</td>
      <td><strong>${m.stock}</strong></td>
      <td>${m.warning_threshold}</td>
      <td>
        <span class="${m.is_warning ? 'status-warning' : 'status-normal'}">
          <i class="fas ${m.is_warning ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
          ${m.is_warning ? 'é¢„è­¦' : 'æ­£å¸¸'}
        </span>
      </td>
      <td>
        <button class="btn btn-primary" onclick="editMedicine(${m.id})" style="padding: 6px 12px; margin-right: 5px;">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-warning" onclick="deleteMedicine(${m.id})" style="padding: 6px 12px;">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
  document.getElementById('medicineList').innerHTML = html;
  updateStats();
}

function editMedicine(id) {
  const med = findMedicine(id);
  if (!med) return;
  document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> ç¼–è¾‘è¯å“';
  document.getElementById('editId').value = 'edit';
  document.getElementById('medId').value = med.id;
  document.getElementById('medName').value = med.name;
  document.getElementById('medOrigin').value = med.origin;
  document.getElementById('medSpec').value = med.spec;
  document.getElementById('medStock').value = med.stock;
  document.getElementById('medThreshold').value = med.warning_threshold;
  document.getElementById('medicineForm').style.display = 'block';
}

function deleteMedicine(id) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤è¯å“ï¼Ÿ')) return;
  const med = findMedicine(id);
  medicines = medicines.filter(m => m.id !== id);
  listAllMedicines();
  log(`ğŸ—‘ï¸ åˆ é™¤è¯å“: ${med.name} (ID:${id})`);
  updateStats();
}

function queryMedicineForm() {
  const keyword = prompt('è¯·è¾“å…¥è¯å“åç§°å…³é”®å­—:');
  if (!keyword) return;
  const matches = medicines.filter(m => m.name.includes(keyword));
  let html = `<h3 class="card-title"><i class="fas fa-search"></i> æŸ¥è¯¢ç»“æœï¼ˆå…±${matches.length}æ¡ï¼‰</h3>`;

  if (matches.length > 0) {
    html += `<div class="table-container"><table>
      <thead>
        <tr>
          <th>ID</th>
          <th>åç§°</th>
          <th>åº“å­˜(g)</th>
          <th>çŠ¶æ€</th>
        </tr>
      </thead>
      <tbody>`;

    matches.forEach(m => {
      html += `<tr>
        <td>${m.id}</td>
        <td><strong>${m.name}</strong></td>
        <td>${m.stock}</td>
        <td>
          <span class="${m.is_warning ? 'status-warning' : 'status-normal'}">
            <i class="fas ${m.is_warning ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i>
            ${m.is_warning ? 'é¢„è­¦' : 'æ­£å¸¸'}
          </span>
        </td>
      </tr>`;
    });

    html += '</tbody></table></div>';
  } else {
    html += `<p style="text-align: center; padding: 20px; color: var(--text-light);">
      <i class="fas fa-search fa-2x" style="margin-bottom: 10px; display: block;"></i>
      æœªæ‰¾åˆ°åŒ¹é…çš„è¯å“
    </p>`;
  }

  document.getElementById('medicineList').innerHTML = html;
}

// ================== å…¥åº“/å‡ºåº“ ==================
function doIn() {
  const id = parseInt(document.getElementById('inMedId').value);
  const qty = parseInt(document.getElementById('inQty').value);
  const op = document.getElementById('inOperator').value;
  const med = findMedicine(id);

  if (!med) {
    log('âŒ è¯å“IDä¸å­˜åœ¨');
    return;
  }

  // è®°å½•å…¥åº“å‰çš„é¢„è­¦çŠ¶æ€
  const wasWarning = med.is_warning;
  
  med.stock += qty;
  inOrders.push({ med_id: id, quantity: qty, operator_name: op, date: today() });
  
  // æ£€æŸ¥é¢„è­¦çŠ¶æ€å˜åŒ–
  const nowWarning = med.stock < med.warning_threshold;
  
  // å¦‚æœä¹‹å‰æ˜¯é¢„è­¦çŠ¶æ€ï¼Œç°åœ¨è§£é™¤äº†ï¼Œè®°å½•å“åº”æ—¶é—´
  if (wasWarning && !nowWarning && med.warning_start_time) {
    const endTime = new Date();
    const startTime = med.warning_start_time;
    const duration = Math.floor((endTime - startTime) / (1000 * 60)); // åˆ†é’Ÿ
    
    // è®°å½•å“åº”æ—¶é—´
    med.warning_response_times.push({
      start: startTime,
      end: endTime,
      duration_minutes: duration
    });
    
    // é‡ç½®é¢„è­¦å¼€å§‹æ—¶é—´
    med.warning_start_time = null;
    
    // åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºå“åº”æ—¶é—´
    log(`âœ… é¢„è­¦è§£é™¤: ${med.name}ï¼Œå“åº”æ—¶é—´: ${duration}åˆ†é’Ÿ`);
  }
  
  checkWarning(id);
  log(`ğŸ“¥ å…¥åº“æˆåŠŸ: ${med.name} +${qty}g, æ“ä½œå‘˜: ${op}, å½“å‰åº“å­˜: ${med.stock}g`);
  updateStats();
}

function doOut() {
  const id = parseInt(document.getElementById('outMedId').value);
  const qty = parseInt(document.getElementById('outQty').value);
  const rx = document.getElementById('prescriptionNo').value;
  const med = findMedicine(id);

  if (!med) {
    log('âŒ è¯å“IDä¸å­˜åœ¨');
    return;
  }

  if (med.stock < qty) {
    log(`âŒ åº“å­˜ä¸è¶³ï¼å½“å‰: ${med.stock}g, è¯·æ±‚: ${qty}g`);
    return;
  }

  const wasWarning = med.is_warning; // è®°å½•é¢„è­¦å‰çŠ¶æ€

  med.stock -= qty;
  outOrders.push({ med_id: id, quantity: qty, prescription_no: rx, date: today() });

  // æ›´æ–°ä»Šæ—¥ç”¨é‡ï¼ˆusage_history[6]ï¼‰
  med.usage_history[6] += qty;
  med.last_usage = med.usage_history[6];

  checkWarning(id);

  // å¦‚æœä¹‹å‰ä¸æ˜¯é¢„è­¦ï¼Œç°åœ¨å˜æˆé¢„è­¦ï¼Œåˆ™æ˜¾ç¤ºå¼¹çª—
  if (!wasWarning && med.is_warning) {
    showAlert(med.name, med.stock, med.warning_threshold);
  }

  log(`ğŸ“¤ å‡ºåº“æˆåŠŸ: ${med.name} -${qty}g, å¤„æ–¹: ${rx}, åº“å­˜: ${med.stock}g`);
  updateStats();
}

// ================== é¢„è­¦é€»è¾‘ ==================
function calculateThreeDayAverage(med) {
  const sum = med.usage_history[4] + med.usage_history[5] + med.usage_history[6];
  const count = 3;
  return sum / count;
}

function setThresholdByUsage() {
  medicines.forEach(med => {
    const avg = calculateThreeDayAverage(med);
    if (avg > 0) {
      med.warning_threshold = Math.max(1, Math.floor(avg * 0.1));
    }
  });
  log('ğŸ”„ å·²æ ¹æ®è¿‘3æ—¥ç”¨é‡æ›´æ–°æ‰€æœ‰è¯å“é¢„è­¦é˜ˆå€¼');
  updateAllWarnings();
}

function checkWarning(id) {
  const med = findMedicine(id);
  if (!med) return;

  const wasWarning = med.is_warning;
  
  if (med.stock < med.warning_threshold) {
    // å˜æˆé¢„è­¦çŠ¶æ€
    med.is_warning = true;
    
    // å¦‚æœæ˜¯æ–°è§¦å‘çš„é¢„è­¦ï¼Œè®°å½•å¼€å§‹æ—¶é—´
    if (!wasWarning) {
      med.warning_start_time = new Date();
      log(`âš ï¸ é¢„è­¦è§¦å‘: ${med.name} (åº“å­˜${med.stock} < é˜ˆå€¼${med.warning_threshold})ï¼Œå¼€å§‹è®¡æ—¶...`);
      
      // æ˜¾ç¤ºé¢„è­¦å¼¹çª—
      showAlert(med.name, med.stock, med.warning_threshold);
    }
  } else {
    // é¢„è­¦è§£é™¤
    if (wasWarning) {
      med.is_warning = false;
      
      // è®¡ç®—å“åº”æ—¶é—´
      if (med.warning_start_time) {
        const endTime = new Date();
        const startTime = med.warning_start_time;
        const duration = Math.floor((endTime - startTime) / (1000 * 60)); // åˆ†é’Ÿ
        
        // è®°å½•å“åº”æ—¶é—´
        med.warning_response_times.push({
          start: startTime,
          end: endTime,
          duration_minutes: duration
        });
        
        // åœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºå“åº”æ—¶é—´
        log(`âœ… é¢„è­¦è§£é™¤: ${med.name}ï¼Œå“åº”æ—¶é—´: ${duration}åˆ†é’Ÿ`);
        
        // é‡ç½®é¢„è­¦å¼€å§‹æ—¶é—´
        med.warning_start_time = null;
      } else {
        log(`âœ… é¢„è­¦è§£é™¤: ${med.name}`);
      }
    }
  }
}

function updateAllWarnings() {
  medicines.forEach(m => checkWarning(m.id));
  showWarningList();
  updateStats();
}

function showWarningList() {
  const warnings = medicines.filter(m => m.is_warning);
  let html = '';

  if (warnings.length === 0) {
    html = `<p style="text-align: center; color: var(--success-color); padding: 20px;">
      <i class="fas fa-check-circle fa-2x" style="margin-bottom: 10px; display: block;"></i>
      å½“å‰æ— é¢„è­¦è¯å“
    </p>`;
  } else {
    html = `<div class="table-container"><table>
      <thead>
        <tr>
          <th>ID</th>
          <th>åç§°</th>
          <th>åº“å­˜(g)</th>
          <th>é˜ˆå€¼(g)</th>
          <th>é¢„è­¦å¼€å§‹æ—¶é—´</th>
          <th>å·²æŒç»­</th>
          <th>çŠ¶æ€</th>
        </tr>
      </thead>
      <tbody>`;

    warnings.forEach(m => {
      let startTimeText = 'æœªè®°å½•';
      let durationText = '';
      
      if (m.warning_start_time) {
        const startTime = m.warning_start_time;
        startTimeText = startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const now = new Date();
        const duration = Math.floor((now - startTime) / (1000 * 60)); // åˆ†é’Ÿ
        if (duration < 60) {
          durationText = `${duration}åˆ†é’Ÿ`;
        } else {
          const hours = Math.floor(duration / 60);
          const mins = duration % 60;
          durationText = `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
        }
      }
      
      html += `<tr>
        <td><strong>${m.id}</strong></td>
        <td><strong>${m.name}</strong></td>
        <td><span class="status-warning">${m.stock}</span></td>
        <td>${m.warning_threshold}</td>
        <td>${startTimeText}</td>
        <td>${durationText}</td>
        <td><span class="status-warning"><i class="fas fa-exclamation-circle"></i> é¢„è­¦ä¸­</span></td>
      </tr>`;
    });

    html += '</tbody></table></div>';
  }

  document.getElementById('warningList').innerHTML = html;
  updateStats();
}

// ================== å“åº”æ—¶é—´æŠ¥è¡¨åŠŸèƒ½ ==================
function showResponseTimeReport() {
  const reportDiv = document.getElementById('responseTimeReport');
  const contentDiv = document.getElementById('responseTimeContent');
  
  // æ”¶é›†æœ‰å“åº”æ—¶é—´è®°å½•çš„è¯å“
  const medsWithResponseTimes = medicines.filter(m => 
    m.warning_response_times && m.warning_response_times.length > 0
  );
  
  if (medsWithResponseTimes.length === 0) {
    contentDiv.innerHTML = `
      <p style="text-align: center; color: var(--text-light); padding: 20px;">
        <i class="fas fa-clock fa-2x" style="margin-bottom: 10px; display: block;"></i>
        æš‚æ— é¢„è­¦å“åº”æ—¶é—´è®°å½•
      </p>
    `;
    reportDiv.style.display = 'block';
    return;
  }
  
  let html = `<div class="table-container"><table>
    <thead>
      <tr>
        <th>è¯å“åç§°</th>
        <th>é¢„è­¦æ¬¡æ•°</th>
        <th>å¹³å‡å“åº”æ—¶é—´(åˆ†é’Ÿ)</th>
        <th>æœ€çŸ­å“åº”æ—¶é—´</th>
        <th>æœ€é•¿å“åº”æ—¶é—´</th>
        <th>æœ€è¿‘å“åº”æ—¶é—´</th>
      </tr>
    </thead>
    <tbody>`;
  
  medsWithResponseTimes.forEach(med => {
    const times = med.warning_response_times;
    const totalDuration = times.reduce((sum, t) => sum + t.duration_minutes, 0);
    const avgDuration = Math.floor(totalDuration / times.length);
    const minDuration = Math.min(...times.map(t => t.duration_minutes));
    const maxDuration = Math.max(...times.map(t => t.duration_minutes));
    const lastResponse = times[times.length - 1];
    const lastResponseTime = lastResponse.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    // æ ¹æ®å“åº”æ—¶é—´ç»™å‡ºè¯„çº§é¢œè‰²
    let ratingColor = '';
    if (avgDuration <= 30) {
      ratingColor = 'color: var(--success-color);';
    } else if (avgDuration <= 120) {
      ratingColor = 'color: #e9c46a;';
    } else {
      ratingColor = 'color: var(--warning-color);';
    }
    
    html += `<tr>
      <td><strong>${med.name}</strong> (ID:${med.id})</td>
      <td><strong>${times.length}æ¬¡</strong></td>
      <td><strong style="${ratingColor}">${avgDuration}åˆ†é’Ÿ</strong></td>
      <td>${minDuration}åˆ†é’Ÿ</td>
      <td>${maxDuration}åˆ†é’Ÿ</td>
      <td>${lastResponseTime}</td>
    </tr>`;
  });
  
  html += '</tbody></table></div>';
  
  // æ·»åŠ ç»Ÿè®¡æ‘˜è¦
  const allResponseTimes = medsWithResponseTimes.flatMap(m => m.warning_response_times);
  const allDurations = allResponseTimes.map(t => t.duration_minutes);
  const overallAvg = allDurations.length > 0 ? 
    Math.floor(allDurations.reduce((a, b) => a + b) / allDurations.length) : 0;
  const totalWarnings = allResponseTimes.length;
  
  html += `
    <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
      <h4 style="color: var(--secondary-color); margin-bottom: 10px;">
        <i class="fas fa-chart-pie"></i> ç»Ÿè®¡æ‘˜è¦
      </h4>
      <div style="display: flex; flex-wrap: wrap; gap: 20px;">
        <div>
          <strong>æ€»é¢„è­¦æ¬¡æ•°:</strong> ${totalWarnings}
        </div>
        <div>
          <strong>å¹³å‡å“åº”æ—¶é—´:</strong> <span style="${overallAvg <= 60 ? 'color: var(--success-color);' : overallAvg <= 180 ? 'color: #e9c46a;' : 'color: var(--warning-color);'}">${overallAvg}åˆ†é’Ÿ</span>
        </div>
        <div>
          <strong>æ¶‰åŠè¯å“æ•°:</strong> ${medsWithResponseTimes.length}
        </div>
        <div>
          <strong>æ€»å“åº”æ—¶é—´:</strong> ${allDurations.reduce((a, b) => a + b, 0)}åˆ†é’Ÿ
        </div>
      </div>
    </div>
  `;
  
  contentDiv.innerHTML = html;
  reportDiv.style.display = 'block';
}

// ================== ç»Ÿè®¡æŠ¥è¡¨ ==================
function getDailyOutTotal(date) {
  return outOrders.filter(o => o.date === date).reduce((sum, o) => sum + o.quantity, 0);
}

function getMedicineOutTotal(medId, date) {
  return outOrders.filter(o => o.med_id === medId && o.date === date).reduce((sum, o) => sum + o.quantity, 0);
}

function getPrescriptionCount(date) {
  return outOrders.filter(o => o.date === date).length;
}

// è®¡ç®—å¹³å‡å“åº”æ—¶é—´
function calculateAvgResponseTime() {
  const allResponseTimes = medicines.flatMap(m => m.warning_response_times);
  if (allResponseTimes.length === 0) return 0;
  
  const totalDuration = allResponseTimes.reduce((sum, t) => sum + t.duration_minutes, 0);
  return Math.floor(totalDuration / allResponseTimes.length);
}

// æ˜¾ç¤ºå¹³å‡å“åº”æ—¶é—´æŠ¥è¡¨
function showAvgResponseTime() {
  const avgResponseTime = calculateAvgResponseTime();
  let html = `<div class="card">
    <h3 class="card-title"><i class="fas fa-stopwatch"></i> å¹³å‡å“åº”æ—¶é—´ç»Ÿè®¡</h3>`;
  
  if (avgResponseTime > 0) {
    html += `
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 3.5rem; color: ${avgResponseTime <= 60 ? 'var(--success-color)' : avgResponseTime <= 180 ? '#e9c46a' : 'var(--warning-color)'}; margin: 20px 0;">
          ${avgResponseTime}<span style="font-size: 1.5rem;">åˆ†é’Ÿ</span>
        </div>
        <div style="font-size: 1.2rem; color: var(--text-light); margin-bottom: 20px;">
          å¹³å‡é¢„è­¦å“åº”æ—¶é—´
        </div>
      </div>`;
    
    // æ˜¾ç¤ºå“åº”æ—¶é—´åˆ†å¸ƒ
    const allResponseTimes = medicines.flatMap(m => m.warning_response_times);
    const quickCount = allResponseTimes.filter(t => t.duration_minutes <= 30).length;
    const normalCount = allResponseTimes.filter(t => t.duration_minutes > 30 && t.duration_minutes <= 120).length;
    const slowCount = allResponseTimes.filter(t => t.duration_minutes > 120).length;
    
    html += `
      <div style="margin-top: 20px;">
        <h4 style="color: var(--secondary-color); margin-bottom: 10px;">
          <i class="fas fa-chart-pie"></i> å“åº”æ—¶é—´åˆ†å¸ƒ
        </h4>
        <div style="display: flex; justify-content: space-around; text-align: center; margin: 20px 0;">
          <div>
            <div style="font-size: 2rem; color: var(--success-color);">${quickCount}</div>
            <div style="color: var(--text-light);">å¿«é€Ÿå“åº”(â‰¤30åˆ†é’Ÿ)</div>
          </div>
          <div>
            <div style="font-size: 2rem; color: #e9c46a;">${normalCount}</div>
            <div style="color: var(--text-light);">æ­£å¸¸å“åº”(30-120åˆ†é’Ÿ)</div>
          </div>
          <div>
            <div style="font-size: 2rem; color: var(--warning-color);">${slowCount}</div>
            <div style="color: var(--text-light);">æ…¢é€Ÿå“åº”(>120åˆ†é’Ÿ)</div>
          </div>
        </div>
      </div>`;
  } else {
    html += `<p style="text-align: center; padding: 20px; color: var(--text-light);">
      <i class="fas fa-clock fa-2x" style="margin-bottom: 10px; display: block;"></i>
      æš‚æ— å“åº”æ—¶é—´æ•°æ®
    </p>`;
  }
  
  html += '</div>';
  document.getElementById('reportOutput').innerHTML = html;
}

function showDailyReport() {
  const date = today();
  const totalDosage = getDailyOutTotal(date);
  const rxCount = getPrescriptionCount(date);
  const avgDosage = rxCount ? (totalDosage / rxCount).toFixed(2) : 0;

  let html = `<div class="card">
    <h3 class="card-title"><i class="fas fa-calendar-day"></i> ${date} æ—¥æŠ¥è¡¨</h3>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-prescription"></i>
        </div>
        <div class="stat-value">${rxCount}</div>
        <div class="stat-label">å¤„æ–¹æ•°é‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-weight"></i>
        </div>
        <div class="stat-value">${totalDosage}</div>
        <div class="stat-label">æ€»å‰‚é‡(g)</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-calculator"></i>
        </div>
        <div class="stat-value">${avgDosage}</div>
        <div class="stat-label">å¹³å‡æ¯æ–¹(g)</div>
      </div>
    </div>`;

  // ç”¨é‡æ’å
  const usageMap = {};
  outOrders.filter(o => o.date === date).forEach(o => {
    usageMap[o.med_id] = (usageMap[o.med_id] || 0) + o.quantity;
  });

  const ranking = Object.entries(usageMap)
    .map(([id, qty]) => ({ id: parseInt(id), qty }))
    .sort((a, b) => b.qty - a.qty)
    .slice(0, 5);

  html += `<h4 style="margin-top: 25px; margin-bottom: 15px; color: var(--secondary-color);">
    <i class="fas fa-trophy"></i> å½“æ—¥ç”¨é‡Top5
  </h4>`;

  if (ranking.length > 0) {
    html += `<div class="table-container"><table>
      <thead>
        <tr>
          <th>æ’å</th>
          <th>è¯å“åç§°</th>
          <th>ç”¨é‡(g)</th>
        </tr>
      </thead>
      <tbody>`;

    ranking.forEach((r, index) => {
      const med = findMedicine(r.id);
      const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ…';
      html += `<tr>
        <td><strong>${medal} ç¬¬${index + 1}å</strong></td>
        <td><strong>${med?.name || 'æœªçŸ¥'}</strong> (ID:${r.id})</td>
        <td><strong>${r.qty}g</strong></td>
      </tr>`;
    });

    html += '</tbody></table></div>';
  } else {
    html += `<p style="text-align: center; padding: 20px; color: var(--text-light);">
      <i class="fas fa-chart-bar fa-2x" style="margin-bottom: 10px; display: block;"></i>
      ä»Šæ—¥æš‚æ— å‡ºåº“è®°å½•
    </p>`;
  }

  html += '</div>';
  document.getElementById('reportOutput').innerHTML = html;
}

function showUsageRanking() {
  const recentDates = [today()];
  // ç®€åŒ–ï¼šåªç»Ÿè®¡ä»Šå¤©
  const usageMap = {};
  outOrders.filter(o => recentDates.includes(o.date)).forEach(o => {
    usageMap[o.med_id] = (usageMap[o.med_id] || 0) + o.quantity;
  });

  const ranking = Object.entries(usageMap)
    .map(([id, qty]) => ({ id: parseInt(id), qty }))
    .sort((a, b) => b.qty - a.qty)
    .slice(0, 5);

  let html = `<div class="card">
    <h3 class="card-title"><i class="fas fa-chart-line"></i> è¿‘3æ—¥ç”¨é‡æ’å</h3>`;

  if (ranking.length > 0) {
    html += `<div class="table-container"><table>
      <thead>
        <tr>
          <th>æ’å</th>
          <th>è¯å“åç§°</th>
          <th>ç”¨é‡(g)</th>
        </tr>
      </thead>
      <tbody>`;

    ranking.forEach((r, index) => {
      const med = findMedicine(r.id);
      html += `<tr>
        <td><strong>ç¬¬${index + 1}å</strong></td>
        <td><strong>${med?.name || 'æœªçŸ¥'}</strong> (ID:${r.id})</td>
        <td><strong style="color: var(--primary-color);">${r.qty}g</strong></td>
      </tr>`;
    });

    html += '</tbody></table></div>';
  } else {
    html += `<p style="text-align: center; padding: 20px; color: var(--text-light);">
      <i class="fas fa-chart-line fa-2x" style="margin-bottom: 10px; display: block;"></i>
      æš‚æ— ç”¨é‡æ•°æ®
    </p>`;
  }

  html += '</div>';
  document.getElementById('reportOutput').innerHTML = html;
}

function showFrequencyRanking() {
  const freqMap = {};
  outOrders.forEach(o => {
    freqMap[o.med_id] = (freqMap[o.med_id] || 0) + 1;
  });

  const ranking = Object.entries(freqMap)
    .map(([id, freq]) => ({ id: parseInt(id), freq }))
    .sort((a, b) => b.freq - a.freq)
    .slice(0, 5);

  let html = `<div class="card">
    <h3 class="card-title"><i class="fas fa-sort-amount-down"></i> è¿‘3æ—¥é¢‘æ¬¡æ’å</h3>`;

  if (ranking.length > 0) {
    html += `<div class="table-container"><table>
      <thead>
        <tr>
          <th>æ’å</th>
          <th>è¯å“åç§°</th>
          <th>å‡ºåº“é¢‘æ¬¡</th>
        </tr>
      </thead>
      <tbody>`;

    ranking.forEach((r, index) => {
      const med = findMedicine(r.id);
      html += `<tr>
        <td><strong>ç¬¬${index + 1}å</strong></td>
        <td><strong>${med?.name || 'æœªçŸ¥'}</strong> (ID:${r.id})</td>
        <td><strong style="color: var(--primary-color);">${r.freq}æ¬¡</strong></td>
      </tr>`;
    });

    html += '</tbody></table></div>';
  } else {
    html += `<p style="text-align: center; padding: 20px; color: var(--text-light);">
      <i class="fas fa-list-ol fa-2x" style="margin-bottom: 10px; display: block;"></i>
      æš‚æ— é¢‘æ¬¡æ•°æ®
    </p>`;
  }

  html += '</div>';
  document.getElementById('reportOutput').innerHTML = html;
}

// ================== åº“å­˜å°è´¦ ==================
function generateLedger() {
  const date = today();
  let html = `<div class="table-container"><table>
    <thead>
      <tr>
        <th>è¯å“ID</th>
        <th>åç§°</th>
        <th>å‰æ—¥ç»“ä½™(g)</th>
        <th>å½“æ—¥å…¥åº“(g)</th>
        <th>å½“æ—¥å‡ºåº“(g)</th>
        <th>å½“æ—¥ç»“ä½™(g)</th>
      </tr>
    </thead>
    <tbody>`;

  let totalIn = 0, totalOut = 0;

  medicines.forEach(med => {
    const dailyIn = inOrders.filter(o => o.med_id === med.id && o.date === date).reduce((s, o) => s + o.quantity, 0);
    const dailyOut = getMedicineOutTotal(med.id, date);
    const prevBalance = med.stock - dailyIn + dailyOut;

    html += `<tr>
      <td><strong>${med.id}</strong></td>
      <td><strong>${med.name}</strong></td>
      <td>${prevBalance}</td>
      <td><span style="color: var(--success-color);">${dailyIn > 0 ? '+' + dailyIn : dailyIn}</span></td>
      <td><span style="color: var(--warning-color);">${dailyOut > 0 ? '-' + dailyOut : dailyOut}</span></td>
      <td><strong>${med.stock}</strong></td>
    </tr>`;

    totalIn += dailyIn;
    totalOut += dailyOut;
  });

  html += `<tr style="background-color: #f8f9fa; font-weight: bold;">
    <td colspan="3">åˆè®¡</td>
    <td style="color: var(--success-color);">${totalIn}</td>
    <td style="color: var(--warning-color);">${totalOut}</td>
    <td></td>
  </tr>`;

  html += '</tbody></table></div>';

  document.getElementById('ledgerTable').innerHTML = html;
}

// ================== ç»Ÿè®¡æ›´æ–° ==================
function updateStats() {
  const warningCount = medicines.filter(m => m.is_warning).length;
  const todayOutTotal = getDailyOutTotal(today());
  const avgResponseTime = calculateAvgResponseTime();

  document.getElementById('totalMedicines').textContent = medicines.length;
  document.getElementById('warningCount').textContent = warningCount;
  document.getElementById('todayOut').textContent = todayOutTotal;
  document.getElementById('avgResponseTime').textContent = avgResponseTime;
}

// ================== UI æ§åˆ¶ ==================
// å¯¼èˆªæŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const section = this.getAttribute('data-section');

    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');

    // æ˜¾ç¤ºå¯¹åº”å†…å®¹åŒºåŸŸ
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(section + 'Section').classList.add('active');
  });
});

// åˆå§‹åŠ è½½
loadInitialData();
listAllMedicines();
updateStats();
</script>
</body>
</html>
