<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸­è¯åº“å­˜é¢„è­¦ç³»ç»Ÿï¼ˆç½‘é¡µç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1, h2, h3 {
      color: #2c3e50;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    button {
      margin: 5px;
      padding: 8px 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #ecf0f1; }
    input, select { padding: 6px; margin: 4px; width: 150px; }
    .section { margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }
    .alert { color: red; font-weight: bold; }
    .success { color: green; }
    pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸŒ¿ ä¸­è¯åº“å­˜é¢„è­¦ç³»ç»Ÿï¼ˆç½‘é¡µç‰ˆï¼‰</h1>

  <div id="mainMenu">
    <button onclick="showSection('medicine')">è¯å“ç®¡ç†</button>
    <button onclick="showSection('inout')">å…¥åº“/å‡ºåº“</button>
    <button onclick="showSection('warning')">é¢„è­¦ç®¡ç†</button>
    <button onclick="showSection('report')">ç»Ÿè®¡æŠ¥è¡¨</button>
    <button onclick="showSection('ledger')">åº“å­˜å°è´¦</button>
  </div>

  <!-- è¯å“ç®¡ç† -->
  <div id="medicineSection" class="section" style="display:none;">
    <h2>ğŸ’Š è¯å“ç®¡ç†</h2>
    <button onclick="addMedicineForm()">æ–°å¢è¯å“</button>
    <button onclick="listAllMedicines()">æ˜¾ç¤ºæ‰€æœ‰è¯å“</button>
    <button onclick="queryMedicineForm()">æŸ¥è¯¢è¯å“</button>
    <div id="medicineForm" style="display:none; margin-top:10px;">
      <h3 id="formTitle">æ–°å¢è¯å“</h3>
      <input type="hidden" id="editId" />
      <label>ID: <input type="number" id="medId" min="1" /></label><br/>
      <label>åç§°: <input type="text" id="medName" /></label><br/>
      <label>äº§åœ°: <input type="text" id="medOrigin" /></label><br/>
      <label>è§„æ ¼: <input type="text" id="medSpec" /></label><br/>
      <label>åº“å­˜(g): <input type="number" id="medStock" min="0" /></label><br/>
      <label>é¢„è­¦é˜ˆå€¼(g): <input type="number" id="medThreshold" min="0" /></label><br/>
      <button onclick="saveMedicine()">ä¿å­˜</button>
      <button onclick="document.getElementById('medicineForm').style.display='none'">å–æ¶ˆ</button>
    </div>
    <div id="medicineList"></div>
  </div>

  <!-- å…¥åº“/å‡ºåº“ -->
  <div id="inoutSection" class="section" style="display:none;">
    <h2>ğŸ“¦ å…¥åº“ / ğŸ“¤ å‡ºåº“</h2>
    <div>
      <h3>å…¥åº“</h3>
      <label>è¯å“ID: <input type="number" id="inMedId" /></label>
      <label>æ•°é‡(g): <input type="number" id="inQty" min="1" /></label>
      <label>æ“ä½œå‘˜: <input type="text" id="inOperator" /></label>
      <button onclick="doIn()">æ‰§è¡Œå…¥åº“</button>
    </div>
    <div style="margin-top:15px;">
      <h3>å‡ºåº“</h3>
      <label>è¯å“ID: <input type="number" id="outMedId" /></label>
      <label>æ•°é‡(g): <input type="number" id="outQty" min="1" /></label>
      <label>å¤„æ–¹å·: <input type="text" id="prescriptionNo" /></label>
      <button onclick="doOut()">æ‰§è¡Œå‡ºåº“</button>
    </div>
    <div id="inoutLog" style="margin-top:10px; height:100px; overflow-y:auto;"></div>
  </div>

  <!-- é¢„è­¦ç®¡ç† -->
  <div id="warningSection" class="section" style="display:none;">
    <h2>âš ï¸ é¢„è­¦ç®¡ç†</h2>
    <button onclick="updateAllWarnings()">æ‰¹é‡æ›´æ–°é¢„è­¦çŠ¶æ€</button>
    <button onclick="setThresholdByUsage()">æŒ‰è¿‘3æ—¥ç”¨é‡è®¾ç½®é˜ˆå€¼</button>
    <div id="warningList"></div>
  </div>

  <!-- ç»Ÿè®¡æŠ¥è¡¨ -->
  <div id="reportSection" class="section" style="display:none;">
    <h2>ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨</h2>
    <button onclick="showDailyReport()">ç”Ÿæˆæ—¥æŠ¥è¡¨</button>
    <button onclick="showUsageRanking()">è¿‘3æ—¥ç”¨é‡æ’å</button>
    <button onclick="showFrequencyRanking()">è¿‘3æ—¥é¢‘æ¬¡æ’å</button>
    <div id="reportOutput" style="margin-top:10px;"></div>
  </div>

  <!-- åº“å­˜å°è´¦ -->
  <div id="ledgerSection" class="section" style="display:none;">
    <h2>ğŸ“’ åº“å­˜å°è´¦</h2>
    <button onclick="generateLedger()">ç”Ÿæˆå½“æ—¥å°è´¦</button>
    <div id="ledgerTable"></div>
  </div>

</div>

<script>
// ================== æ•°æ®åˆå§‹åŒ– ==================
let medicines = []; // è¯å“åˆ—è¡¨ [{id, name, origin, spec, stock, warning_threshold, is_warning, usage_history: [7], last_usage}]
let inOrders = [];  // å…¥åº“å•é˜Ÿåˆ— [{med_id, quantity, operator_name, date}]
let outOrders = []; // å‡ºåº“å•æ ˆï¼ˆæ•°ç»„ï¼Œé¡¶éƒ¨åœ¨æœ«å°¾ï¼‰[{med_id, quantity, prescription_no, date}]

// å½“å‰æ—¥æœŸå·¥å…·
function today() {
  const d = new Date();
  return d.toISOString().split('T')[0]; // "YYYY-MM-DD"
}

// åŠ è½½ CSV æ•°æ®ï¼ˆæ¨¡æ‹Ÿï¼‰
function loadInitialData() {
  // è§£æè¯ç‰©åŸºæœ¬ä¿¡æ¯.csv
  const basicCSV = `ç¼–å·,åç§°,äº§åœ°,è§„æ ¼,åº“å­˜é‡(g),åŸºç¡€é˜ˆå€¼(g)
ZY0001,éº»é»„,å†…è’™å¤,é¥®ç‰‡/500g,12500,3000
ZY0002,æ¡‚æ,å¹¿è¥¿,é¥®ç‰‡/500g,8500,2000
ZY0003,ç´«è‹å¶,æ±Ÿè‹,é¥®ç‰‡/250g,6200,1500
ZY0004,è†èŠ¥,æ±Ÿè¥¿,é¥®ç‰‡/500g,7800,1800
ZY0005,é˜²é£,é»‘é¾™æ±Ÿ,é¥®ç‰‡/500g,9200,2200
ZY0006,ç¾Œæ´»,å››å·,é¥®ç‰‡/500g,6800,1600
ZY0007,ç™½èŠ·,æµ™æ±Ÿ,é¥®ç‰‡/500g,7500,1700
ZY0008,ç»†è¾›,è¾½å®,é¥®ç‰‡/100g,3500,800
ZY0009,è–„è·,æ±Ÿè‹,é¥®ç‰‡/250g,4800,1200
ZY0010,èŠèŠ±,å®‰å¾½,é¥®ç‰‡/500g,10500,2500`;

  const lines = basicCSV.trim().split('\n');
  for (let i = 1; i < lines.length; i++) {
    const parts = lines[i].split(',');
    if (parts.length >= 6) {
      const id = parseInt(parts[0].replace('ZY', ''));
      medicines.push({
        id,
        name: parts[1],
        origin: parts[2],
        spec: parts[3],
        stock: parseInt(parts[4]),
        warning_threshold: parseInt(parts[5]),
        is_warning: false,
        usage_history: Array(7).fill(0),
        last_usage: 0
      });
    }
  }

  // åˆå§‹åŒ–è¿‘7æ—¥ç”¨é‡ï¼ˆä»…å‰5ç§æœ‰æ•°æ®ï¼‰
  const usageCSV = `Ñ…ÑƒÑ„Ğ·,Ğ±Ğ˜â•©Ñ„(ZY0001),â•§ĞŸĞ¶â••(ZY0002),Ğ²Ğ¾ĞºÑƒÑ€â•¤(ZY0003),â•¬Ñ‘â•«Ğ¤(ZY0004),â•¥Ñâ•¥Ğ“(ZY0005)
D-6,850,620,480,520,710
D-5,920,580,510,490,680
D-4,780,650,460,530,720
D-3,1050,720,550,580,810
D-2,980,680,520,560,790
D-1,1100,750,590,610,850
D-0,890,640,500,540,730`;
  
  const usageLines = usageCSV.trim().split('\n');
  const headers = usageLines[0].split(',').slice(1); // è·³è¿‡ç¬¬ä¸€åˆ—
  const medIdsFromHeader = headers.map(h => parseInt(h.match(/\d+/)[0])); // æå– ZY0001 â†’ 1

  for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
    const values = usageLines[dayIdx + 1].split(',').slice(1);
    for (let j = 0; j < values.length; j++) {
      const medId = medIdsFromHeader[j];
      const med = medicines.find(m => m.id === medId);
      if (med) {
        med.usage_history[dayIdx] = parseInt(values[j]);
        if (dayIdx === 6) med.last_usage = parseInt(values[j]);
      }
    }
  }

  console.log("åˆå§‹æ•°æ®åŠ è½½å®Œæˆ", medicines);
}

// ================== å·¥å…·å‡½æ•° ==================
function findMedicine(id) {
  return medicines.find(m => m.id === id);
}

function log(msg) {
  const logDiv = document.getElementById('inoutLog');
  logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
  logDiv.scrollTop = logDiv.scrollHeight;
}

// ================== è¯å“ç®¡ç† ==================
function addMedicineForm() {
  document.getElementById('formTitle').textContent = 'æ–°å¢è¯å“';
  document.getElementById('editId').value = '';
  ['medId','medName','medOrigin','medSpec','medStock','medThreshold'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('medicineForm').style.display = 'block';
}

function saveMedicine() {
  const id = parseInt(document.getElementById('medId').value);
  const existing = findMedicine(id);
  const isEdit = document.getElementById('editId').value !== '';

  if (!isEdit && existing) {
    alert('è¯å“IDå·²å­˜åœ¨ï¼');
    return;
  }

  const med = {
    id,
    name: document.getElementById('medName').value,
    origin: document.getElementById('medOrigin').value,
    spec: document.getElementById('medSpec').value,
    stock: parseInt(document.getElementById('medStock').value) || 0,
    warning_threshold: parseInt(document.getElementById('medThreshold').value) || 0,
    is_warning: false,
    usage_history: Array(7).fill(0),
    last_usage: 0
  };

  if (isEdit) {
    const idx = medicines.findIndex(m => m.id === id);
    medicines[idx] = med;
  } else {
    medicines.push(med);
  }

  document.getElementById('medicineForm').style.display = 'none';
  listAllMedicines();
  log(`âœ… ${isEdit ? 'ä¿®æ”¹' : 'æ–°å¢'}è¯å“: ${med.name} (ID:${med.id})`);
}

function listAllMedicines() {
  let html = `<table><tr><th>ID</th><th>åç§°</th><th>äº§åœ°</th><th>è§„æ ¼</th><th>åº“å­˜(g)</th><th>é˜ˆå€¼(g)</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>`;
  medicines.forEach(m => {
    html += `<tr>
      <td>${m.id}</td>
      <td>${m.name}</td>
      <td>${m.origin}</td>
      <td>${m.spec}</td>
      <td>${m.stock}</td>
      <td>${m.warning_threshold}</td>
      <td style="color:${m.is_warning ? 'red' : 'green'}">${m.is_warning ? 'é¢„è­¦' : 'æ­£å¸¸'}</td>
      <td>
        <button onclick="editMedicine(${m.id})">ç¼–è¾‘</button>
        <button onclick="deleteMedicine(${m.id})">åˆ é™¤</button>
      </td>
    </tr>`;
  });
  html += '</table>';
  document.getElementById('medicineList').innerHTML = html;
}

function editMedicine(id) {
  const med = findMedicine(id);
  if (!med) return;
  document.getElementById('formTitle').textContent = 'ç¼–è¾‘è¯å“';
  document.getElementById('editId').value = 'edit';
  document.getElementById('medId').value = med.id;
  document.getElementById('medName').value = med.name;
  document.getElementById('medOrigin').value = med.origin;
  document.getElementById('medSpec').value = med.spec;
  document.getElementById('medStock').value = med.stock;
  document.getElementById('medThreshold').value = med.warning_threshold;
  document.getElementById('medicineForm').style.display = 'block';
}

function deleteMedicine(id) {
  if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
  medicines = medicines.filter(m => m.id !== id);
  listAllMedicines();
  log(`ğŸ—‘ï¸ åˆ é™¤è¯å“ ID:${id}`);
}

function queryMedicineForm() {
  const keyword = prompt('è¯·è¾“å…¥è¯å“åç§°å…³é”®å­—:');
  if (!keyword) return;
  const matches = medicines.filter(m => m.name.includes(keyword));
  let html = `<h3>æŸ¥è¯¢ç»“æœï¼ˆå…±${matches.length}æ¡ï¼‰</h3><table><tr><th>ID</th><th>åç§°</th><th>åº“å­˜</th><th>çŠ¶æ€</th></tr>`;
  matches.forEach(m => {
    html += `<tr><td>${m.id}</td><td>${m.name}</td><td>${m.stock}</td><td style="color:${m.is_warning?'red':'green'}">${m.is_warning?'é¢„è­¦':'æ­£å¸¸'}</td></tr>`;
  });
  html += '</table>';
  document.getElementById('medicineList').innerHTML = html;
}

// ================== å…¥åº“/å‡ºåº“ ==================
function doIn() {
  const id = parseInt(document.getElementById('inMedId').value);
  const qty = parseInt(document.getElementById('inQty').value);
  const op = document.getElementById('inOperator').value;
  const med = findMedicine(id);
  if (!med) {
    log('âŒ è¯å“IDä¸å­˜åœ¨');
    return;
  }
  med.stock += qty;
  inOrders.push({ med_id: id, quantity: qty, operator_name: op, date: today() });
  checkWarning(id);
  log(`ğŸ“¥ å…¥åº“æˆåŠŸ: ${med.name} +${qty}g, æ“ä½œå‘˜: ${op}, å½“å‰åº“å­˜: ${med.stock}g`);
}

function doOut() {
  const id = parseInt(document.getElementById('outMedId').value);
  const qty = parseInt(document.getElementById('outQty').value);
  const rx = document.getElementById('prescriptionNo').value;
  const med = findMedicine(id);
  if (!med) {
    log('âŒ è¯å“IDä¸å­˜åœ¨');
    return;
  }
  if (med.stock < qty) {
    log(`âŒ åº“å­˜ä¸è¶³ï¼å½“å‰: ${med.stock}g, è¯·æ±‚: ${qty}g`);
    return;
  }
  med.stock -= qty;
  outOrders.push({ med_id: id, quantity: qty, prescription_no: rx, date: today() });

  // æ›´æ–°ä»Šæ—¥ç”¨é‡ï¼ˆusage_history[6]ï¼‰
  med.usage_history[6] += qty;
  med.last_usage = med.usage_history[6];

  checkWarning(id);
  log(`ğŸ“¤ å‡ºåº“æˆåŠŸ: ${med.name} -${qty}g, å¤„æ–¹: ${rx}, åº“å­˜: ${med.stock}g`);
}

// ================== é¢„è­¦é€»è¾‘ ==================
function calculateThreeDayAverage(med) {
  const sum = med.usage_history[4] + med.usage_history[5] + med.usage_history[6];
  const count = 3;
  return sum / count;
}

function setThresholdByUsage() {
  medicines.forEach(med => {
    const avg = calculateThreeDayAverage(med);
    if (avg > 0) {
      med.warning_threshold = Math.max(1, Math.floor(avg * 0.1));
    }
  });
  log('ğŸ”„ å·²æ ¹æ®è¿‘3æ—¥ç”¨é‡æ›´æ–°æ‰€æœ‰è¯å“é¢„è­¦é˜ˆå€¼');
  updateAllWarnings();
}

function checkWarning(id) {
  const med = findMedicine(id);
  if (!med) return;

  const wasWarning = med.is_warning;
  if (med.stock < med.warning_threshold) {
    med.is_warning = true;
    if (!wasWarning) {
      log(`âš ï¸ é¢„è­¦è§¦å‘: ${med.name} (åº“å­˜${med.stock} < é˜ˆå€¼${med.warning_threshold})`);
    }
  } else {
    if (wasWarning) {
      med.is_warning = false;
      log(`âœ… é¢„è­¦è§£é™¤: ${med.name}`);
    }
  }
}

function updateAllWarnings() {
  medicines.forEach(m => checkWarning(m.id));
  showWarningList();
}

function showWarningList() {
  const warnings = medicines.filter(m => m.is_warning);
  let html = '<h3>å½“å‰é¢„è­¦è¯å“</h3>';
  if (warnings.length === 0) {
    html += '<p>ğŸŸ¢ æ— é¢„è­¦è¯å“</p>';
  } else {
    html += '<ul>';
    warnings.forEach(m => {
      html += `<li>${m.name} (ID:${m.id}) - åº“å­˜: ${m.stock}g, é˜ˆå€¼: ${m.warning_threshold}g</li>`;
    });
    html += '</ul>';
  }
  document.getElementById('warningList').innerHTML = html;
}

// ================== ç»Ÿè®¡æŠ¥è¡¨ ==================
function getDailyOutTotal(date) {
  return outOrders.filter(o => o.date === date).reduce((sum, o) => sum + o.quantity, 0);
}

function getMedicineOutTotal(medId, date) {
  return outOrders.filter(o => o.med_id === medId && o.date === date).reduce((sum, o) => sum + o.quantity, 0);
}

function getPrescriptionCount(date) {
  return outOrders.filter(o => o.date === date).length;
}

function showDailyReport() {
  const date = today();
  const totalDosage = getDailyOutTotal(date);
  const rxCount = getPrescriptionCount(date);
  const avgDosage = rxCount ? (totalDosage / rxCount).toFixed(2) : 0;

  let html = `<h3>ğŸ“… ${date} æ—¥æŠ¥è¡¨</h3>`;
  html += `<p>å¤„æ–¹æ•°é‡: ${rxCount}</p>`;
  html += `<p>æ€»å‰‚é‡: ${totalDosage}g</p>`;
  html += `<p>å¹³å‡æ¯æ–¹: ${avgDosage}g</p>`;

  // ç”¨é‡æ’å
  const usageMap = {};
  outOrders.filter(o => o.date === date).forEach(o => {
    usageMap[o.med_id] = (usageMap[o.med_id] || 0) + o.quantity;
  });
  const ranking = Object.entries(usageMap)
    .map(([id, qty]) => ({ id: parseInt(id), qty }))
    .sort((a, b) => b.qty - a.qty)
    .slice(0, 5);

  html += `<h4>å½“æ—¥ç”¨é‡Top5:</h4><ol>`;
  ranking.forEach(r => {
    const med = findMedicine(r.id);
    html += `<li>${med?.name || 'æœªçŸ¥'}: ${r.qty}g</li>`;
  });
  html += '</ol>';

  document.getElementById('reportOutput').innerHTML = html;
}

function showUsageRanking() {
  const recentDates = [today()];
  // ç®€åŒ–ï¼šåªç»Ÿè®¡ä»Šå¤©
  const usageMap = {};
  outOrders.filter(o => recentDates.includes(o.date)).forEach(o => {
    usageMap[o.med_id] = (usageMap[o.med_id] || 0) + o.quantity;
  });
  const ranking = Object.entries(usageMap)
    .map(([id, qty]) => ({ id: parseInt(id), qty }))
    .sort((a, b) => b.qty - a.qty)
    .slice(0, 5);

  let html = `<h3>è¿‘3æ—¥ç”¨é‡æ’åï¼ˆç®€åŒ–ç‰ˆï¼‰</h3><ol>`;
  ranking.forEach(r => {
    const med = findMedicine(r.id);
    html += `<li>${med?.name || 'æœªçŸ¥'} (ID:${r.id}): ${r.qty}g</li>`;
  });
  html += '</ol>';
  document.getElementById('reportOutput').innerHTML = html;
}

function showFrequencyRanking() {
  const freqMap = {};
  outOrders.forEach(o => {
    freqMap[o.med_id] = (freqMap[o.med_id] || 0) + 1;
  });
  const ranking = Object.entries(freqMap)
    .map(([id, freq]) => ({ id: parseInt(id), freq }))
    .sort((a, b) => b.freq - a.freq)
    .slice(0, 5);

  let html = `<h3>è¿‘3æ—¥é¢‘æ¬¡æ’å</h3><ol>`;
  ranking.forEach(r => {
    const med = findMedicine(r.id);
    html += `<li>${med?.name || 'æœªçŸ¥'} (ID:${r.id}): ${r.freq}æ¬¡</li>`;
  });
  html += '</ol>';
  document.getElementById('reportOutput').innerHTML = html;
}

// ================== åº“å­˜å°è´¦ ==================
function generateLedger() {
  const date = today();
  let html = `<table><tr><th>è¯å“ID</th><th>åç§°</th><th>å‰æ—¥ç»“ä½™</th><th>å½“æ—¥å…¥åº“</th><th>å½“æ—¥å‡ºåº“</th><th>å½“æ—¥ç»“ä½™</th></tr>`;
  let totalIn = 0, totalOut = 0;

  medicines.forEach(med => {
    const dailyIn = inOrders.filter(o => o.med_id === med.id && o.date === date).reduce((s, o) => s + o.quantity, 0);
    const dailyOut = getMedicineOutTotal(med.id, date);
    const prevBalance = med.stock - dailyIn + dailyOut;

    html += `<tr>
      <td>${med.id}</td>
      <td>${med.name}</td>
      <td>${prevBalance}</td>
      <td>${dailyIn}</td>
      <td>${dailyOut}</td>
      <td>${med.stock}</td>
    </tr>`;

    totalIn += dailyIn;
    totalOut += dailyOut;
  });

  html += `<tr><td colspan="3">åˆè®¡</td><td>${totalIn}</td><td>${totalOut}</td><td></td></tr>`;
  html += '</table>';
  document.getElementById('ledgerTable').innerHTML = html;
}

// ================== UI æ§åˆ¶ ==================
function showSection(section) {
  ['medicine','inout','warning','report','ledger'].forEach(s => {
    document.getElementById(s + 'Section').style.display = 'none';
  });
  document.getElementById(section + 'Section').style.display = 'block';
}

// ================== å¯åŠ¨ ==================
loadInitialData();
showSection('medicine');
listAllMedicines();
</script>
</body>
</html>
